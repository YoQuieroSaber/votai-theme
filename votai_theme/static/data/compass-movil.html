<!DOCTYPE html>
<html>
<head>
	<title>YQS Compass</title>
	<meta http-equiv="content-type" value="text/html; charset=UTF-8">
	<style>
		body,table {
			font-family: sans-serif;
			font-size: 0.75em;
		}
		.candidato {
			width: 40px;
			height: 40px;
			position: absolute;
			border-radius: 20px;
			margin-top: -20px;
			background-size: contain;

		}
		.contenedor {
			position: relative;
			border-top: 2px solid #CCC;
			margin: 35px;
			width: 200px;
			height: 200px;
			margin-left: 200px;
			margin-top: 200px;
			border-left: 2px solid #ccc;		
		}
		input.answervalue {
			width: 2em;
		}
	</style>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script>
	window.jQuery || document.write('<script src="js/vendor/jquery-1.10.1.min.js"><\/script>')
	</script>

</head>
<body>
	<script>

	var answer_values = {"105_x":0,"105_y":1,"106_x":0,"106_y":0.5,"107_x":0,"107_y":-0.5,"108_x":0,"108_y":-1,"109_x":0,"109_y":1,"110_x":0,"110_y":0.5,"111_x":0,"111_y":-0.5,"112_x":0,"112_y":-1,"113_x":0,"113_y":-1,"114_x":0,"114_y":0,"116_x":0,"116_y":0,"117_x":0,"117_y":0,"118_x":0,"118_y":0,"119_x":0,"119_y":0,"120_x":0,"120_y":0,"121_x":0,"121_y":0,"122_x":0,"122_y":0,"125_x":1,"125_y":0,"126_x":0.5,"126_y":0,"127_x":-0.5,"127_y":0,"128_x":-1,"128_y":0,"129_x":1,"129_y":0,"130_x":0,"130_y":0,"133_x":0,"133_y":0,"134_x":0,"134_y":0,"135_x":0,"135_y":0,"136_x":0,"136_y":0,"137_x":0,"137_y":0,"138_x":0,"138_y":0,"139_x":0,"139_y":0,"140_x":0,"140_y":0,"154_x":0,"154_y":0,"155_x":0,"155_y":0,"156_x":0,"156_y":0,"145_x":0,"145_y":0,"148_x":0,"148_y":0,"149_x":0,"149_y":0,"152_x":0,"152_y":0,"157_x":0,"157_y":0,"158_x":0,"158_y":0,"161_x":-1,"161_y":0,"163_x":-0.5,"163_y":0,"165_x":0,"165_y":0,"167_x":0,"167_y":0,"168_x":0,"168_y":0,"141_x":0,"141_y":0,"144_x":0,"144_y":0,"169_x":-1,"169_y":0,"170_x":0.5,"170_y":0,"171_x":-0.5,"171_y":0,"172_x":1,"172_y":0};


	function answer(answer_id,data) {
		for (c in data.categories) {
			var category = data.categories[c];
			for (q in category.questions) {
				var question = category.questions[q];
				if ($("#question_"+question.question_id).length == 0) {
					$("#form").append("<div id='question_"+question.question_id+"'>"+question.question_text+"</div>");
				}

				for (a in question.answers) { 
					var answer = question.answers[a];
					if(answer.answer_id == answer_id) {
						if ($("#answer_"+answer_id).length == 0) {
							$("#question_"+question.question_id).append("<div id='answer_"+answer_id+"'>"+answer.answer_text+" x:<input type='text' id='answer_"+answer_id+"_x' class='answervalue' value='"+answer_values[answer_id+"_x"]+"'>y:<input type='text' id='answer_"+answer_id+"_y' class='answervalue' value='"+answer_values[answer_id+"_y"]+"'></div>")
						}
						answer_values[answer_id+"_x"] = parseFloat($("#answer_"+answer_id+"_x").val());
						answer_values[answer_id+"_y"] = parseFloat($("#answer_"+answer_id+"_y").val());
						return answer;
					}
				}
			}
		}
	}


	function election_table(data) {
		// console.log(data);

		$("body").find("h2").text(data.election_name);
		contenedor = $(".contenedor");
		form = $(".form");
		
		for (c in data.candidates) {
			var candidate = data.candidates[c];
			candidate.answers = [];
			candidate.suma_x = 0;
			candidate.suma_y = 0;
			candidate.posicion_x = 0;
			candidate.posicion_y = 0;
			for (p in candidate.positions) {
				var position = candidate.positions[p];
				ans = answer(position.answer_id,data);
				// console.log(ans);
				candidate.answers.push(ans);
			}
			for (a in candidate.answers) {
				// console.log(candidate.answers[a]);
				candidate.suma_x += answer_values[candidate.answers[a].answer_id+"_x"];
				candidate.suma_y += answer_values[candidate.answers[a].answer_id+"_y"];
			}
			candidate.posicion_x = (candidate.suma_x/candidate.answers.length);
			candidate.posicion_y = (candidate.suma_y/candidate.answers.length);

			if ($("#candidate_"+candidate.candidate_id).length == 0) {
				candi = $("<div></div>").addClass("candidato").attr('id',"candidate_"+candidate.candidate_id);
				contenedor.append(candi);
				candi.css("background-color", candidate.candidate_color)
				candi.css("background-image", "url("+candidate.candidate_pic+")");				
			}

			candi = $("#candidate_"+candidate.candidate_id);
			pos_x = candidate.posicion_x*200;
			pos_y = candidate.posicion_y*200;
			candi.css("left", pos_x + "px");
			candi.css("top", pos_y + "px");
			candi.attr("title",candidate.candidate_name + " x"+candidate.posicion_x + " y"+candidate.posicion_y);
		}
		console.log(data);
		$("#values").val(JSON.stringify(answer_values));
    }



    function init() {
    	console.log("init");
        $.getJSON("/theme/election/pre-candidato-a-presidente/media-naranja.json", election_table);
        // $.getJSON("http://elecciones2015.yoquierosaber.org/theme/election/pre-candidato-a-gobernador-de-buenos-aires/media-naranja.json", election_table);
        // $.getJSON("http://elecciones2015.yoquierosaber.org/theme/election/pre-candidato-a-gobernador-de-tucuman/media-naranja.json", election_table);
        // $.getJSON("http://elecciones2015.yoquierosaber.org/theme/election/pre-candidato-a-gobernador-de-san-juan/media-naranja.json", election_table);
        // $.getJSON("http://elecciones2015.yoquierosaber.org/theme/election/pre-candidato-a-gobernador-de-entre-rios/media-naranja.json", election_table);

    }

    init();
	$("body").on("change",".answervalue", null, init);

	</script>

	<div id='compass'>
		<h2></h2>
		<p></p>
		<div class="contenedor"></div>
		<div id="form">
			<h2>Posiciones</h2>
			<p>Por favor ayudanos a definir los valores para cada posición. En el campo "x", el valor va de -1 para izquierda económica, a 1 para derecha económica. En el campo "y" el valor va de -1 para socialmente autoritario a 1 para socialmente liberal.<br/>
			Una vez que hayas definido valores para cada una de las posiciones, copiá el contneido de valores combinados y envialo a info@yoquierosaber.org<br/>
			Por favor notá que el gráfico se actualiza automaticamente luego de cada cambio.<br/>
			Gracias.<br/>
			Valores combinados: <input id='values'>
		</div>
	</div>

</body>
</html>
